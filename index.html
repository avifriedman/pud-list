<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast RSS Viewer - Debug Mode</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; direction: rtl; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { width: 70%; padding: 10px; font-size: 16px; }
        button { width: 25%; padding: 10px; font-size: 16px; background: #28a745; color: white; border: none; cursor: pointer; }
        button:hover { background: #218838; }
        #status { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 4px; font-family: monospace; font-size: 12px; color: #333; min-height: 20px; }
        .item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; align-items: center; }
        .index { background: #007bff; color: white; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 10px; font-weight: bold; flex-shrink: 0; }
        .details { flex-grow: 1; }
        .date { font-size: 12px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>מציג פודקאסטים (גרסה יציבה)</h2>
    <div>
        <input type="text" id="rssUrl" placeholder="הדבק קישור RSS כאן..." value="https://www.spreaker.com/show/4393905/episodes/feed">
        <button onclick="startFetch()">הצג פרקים</button>
    </div>
    
    <!-- אזור לוגים כדי שנבין מה קורה -->
    <div id="status">ממתין לפעולה...</div>
    
    <div id="results"></div>
</div>

<script>
    function log(msg, isError = false) {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML += `<div>${isError ? '❌' : '✅'} ${msg}</div>`;
        statusDiv.scrollTop = statusDiv.scrollHeight;
        if (isError) statusDiv.style.backgroundColor = "#f8d7da";
    }

    async function startFetch() {
        const url = document.getElementById('rssUrl').value.trim();
        const resultsDiv = document.getElementById('results');
        const statusDiv = document.getElementById('status');
        
        // איפוס
        resultsDiv.innerHTML = '';
        statusDiv.innerHTML = 'מתחיל תהליך...';
        statusDiv.style.backgroundColor = "#e9ecef";

        if (!url) {
            log("נא להזין קישור RSS", true);
            return;
        }

        try {
            log(`מנסה לטעון את הכתובת: ${url}`);

            // שיטה 1: שימוש ב-RSS2JSON (שירות המרה אמין)
            // זה עוקף CORS וגם פותר בעיות של XML שבור
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=0000000000000000000000000000000000000000&count=100`; 
            
            log("פונה לשרת המרה...");
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`שגיאת רשת: ${response.status}`);
            }

            const data = await response.json();

            if (data.status !== 'ok') {
                // אם השירות הזה נכשל, ננסה את השיטה הישנה (XML Proxy)
                log("RSS2JSON נכשל, מנסה שיטת גיבוי (XML)...", true);
                await fetchWithBackup(url);
                return;
            }

            log(`התקבלו ${data.items.length} פרקים! בונה רשימה...`);
            renderList(data.items);

        } catch (e) {
            log(`שגיאה כללית: ${e.message}`, true);
            console.error(e);
            // ניסיון אחרון עם השיטה השנייה
            await fetchWithBackup(url);
        }
    }

    // פונקציית גיבוי למקרה שהראשונה נכשלת
    async function fetchWithBackup(url) {
        try {
            log("מנסה דרך שרת גיבוי (AllOrigins)...");
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            const data = await response.json();
            
            if (!data.contents) throw new Error("לא התקבל תוכן");

            // המרה ידנית מ-XML
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(data.contents, "text/xml");
            const items = xmlDoc.querySelectorAll("item");
            
            if (items.length === 0) throw new Error("לא נמצאו פרקים ב-XML");

            const list = [];
            items.forEach(item => {
                list.push({
                    title: item.querySelector("title")?.textContent || "ללא כותרת",
                    pubDate: item.querySelector("pubDate")?.textContent || ""
                });
            });

            log(`הצלחה בגיבוי! ${list.length} פרקים.`);
            renderList(list);

        } catch (e) {
            log(`גם הגיבוי נכשל: ${e.message}`, true);
        }
    }

    function renderList(items) {
        const container = document.getElementById('results');
        
        // שים לב: ב-RSS רגיל, הפריט הראשון (אינדקס 0) הוא הכי חדש (מספר 1 להורדה)
        items.forEach((item, index) => {
            const downloadNum = index + 1;
            let dateStr = item.pubDate;
            try { dateStr = new Date(item.pubDate).toLocaleDateString('he-IL'); } catch(e){}

            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <div class="index">${downloadNum}</div>
                <div class="details">
                    <div style="font-weight:bold">${item.title}</div>
                    <div class="date">${dateStr}</div>
                </div>
            `;
            container.appendChild(div);
        });
        log("סיום - הרשימה מוצגת.");
    }
</script>

</body>
</html>
