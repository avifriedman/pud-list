<script>
    async function fetchEpisodes() {
        const urlInput = document.getElementById('rssUrl').value.trim();
        const listContainer = document.getElementById('list');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        if (!urlInput) return;

        // Reset UI
        listContainer.innerHTML = '';
        errorDiv.textContent = '';
        loading.style.display = 'block';

        try {
            // שינוי לפרוקסי חזק יותר - corsproxy.io
            // הוא מוסיף את הקישור שלנו אחרי הכתובת שלו
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(urlInput);
            
            const response = await fetch(proxyUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const str = await response.text();
            
            // בדיקה שהתקבל XML תקין ולא הודעת שגיאה מהפרוקסי
            if (!str.startsWith('<') && !str.includes('xml')) {
                throw new Error('התקבל תוכן שאינו XML תקין');
            }

            const data = new window.DOMParser().parseFromString(str, "text/xml");
            
            // בדיקה אם הייתה שגיאת פענוח XML
            if (data.querySelector("parsererror")) {
                throw new Error('שגיאה בפענוח ה-XML');
            }

            const items = data.querySelectorAll("item");
            
            if (items.length === 0) {
                errorDiv.textContent = "לא נמצאו פרקים בפיד זה (או שהפיד ריק).";
                loading.style.display = 'none';
                return;
            }

            // יצירת הרשימה
            items.forEach((item, index) => {
                // בדיקת תקינות לכל שדה כדי למנוע קריסה
                const titleNode = item.querySelector("title");
                const title = titleNode ? titleNode.textContent : "ללא כותרת";
                
                const pubDateNode = item.querySelector("pubDate");
                const pubDate = pubDateNode ? pubDateNode.textContent : "";
                
                let dateStr = "";
                if (pubDate) {
                    try {
                        const d = new Date(pubDate);
                        dateStr = d.toLocaleDateString('he-IL');
                    } catch (e) {
                        dateStr = "תאריך לא ידוע";
                    }
                }

                // המספר הסידורי להורדה
                const downloadIndex = index + 1;

                const li = document.createElement('li');
                li.className = 'episode-item';
                li.innerHTML = `
                    <div class="episode-index" title="מספר להורדה">${downloadIndex}</div>
                    <div class="episode-content">
                        <div class="episode-title">${title}</div>
                        <div class="episode-date">${dateStr}</div>
                    </div>
                `;
                listContainer.appendChild(li);
            });

        } catch (error) {
            console.error("Full error details:", error);
            errorDiv.innerHTML = `שגיאה בטעינת הפיד.<br><small style="color:#999">${error.message}</small>`;
        } finally {
            loading.style.display = 'none';
        }
    }
</script>
